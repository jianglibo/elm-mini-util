<!DOCTYPE html>

<head>
  <title>Pusher Test</title>
  <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
  <script src="/pusher.elm.js"></script>
  <script>

    // elm make src/Pusher.elm --output=pusher.elm.js --optimize

    // Enable pusher logging - don't include this in production
    Pusher.logToConsole = true;

    function cb(channel_name) {

    }

    // cb();

  </script>
  <link rel="stylesheet" href="/assets/css/pusher.css">
</head>

<body>
  <h1>Pusher Test</h1>
  <div id="myapp">
    <div id="my_app"></div>
  </div>
  <script>
    var app = Elm.Pusher.init({
      node: document.getElementById('my_app'),
      flags: { cpsyc_url: "http://localhost:8080" }
    });

    app.ports.subscribeToPusher.subscribe(function (channel_name) {
      var pusher = new Pusher('83301c9b5a9e5ad71ee6', {
        cluster: 'eu',
        authEndpoint: "http://localhost:8080/pusher/auth",
        authTransport: "ajax"
      });

      var socketId = null;
      pusher.connection.bind("connected", () => {
        socketId = pusher.connection.socket_id;
        app.ports.socketIdAcquired.send(socketId);
      });

      var channel = pusher.subscribe('private-' + channel_name);
      channel.bind('my-event', function (data) {
        app.ports.eventFromPusher.send(data);
      });
    });


    if (app.ports && app.ports.askForConfirmation) {
      app.ports.askForConfirmation.subscribe(function () {
        app.ports.confirmations.send(window.confirm())
      });
    }
  </script>
  <p>
  </p>
</body>